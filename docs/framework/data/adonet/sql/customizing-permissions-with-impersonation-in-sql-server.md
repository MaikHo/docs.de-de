---
title: Anpassen von Berechtigungen durch Identitätswechsel in SQL Server
ms.date: 03/30/2017
ms.assetid: dc733d09-1d6d-4af0-9c4b-8d24504860f1
ms.openlocfilehash: 84c5585912ba259fdcefaae186138c4466b16206
ms.sourcegitcommit: 5b475c1855b32cf78d2d1bbb4295e4c236f39464
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 09/24/2020
ms.locfileid: "91180854"
---
# <a name="customizing-permissions-with-impersonation-in-sql-server"></a><span data-ttu-id="f0005-102">Anpassen von Berechtigungen durch Identitätswechsel in SQL Server</span><span class="sxs-lookup"><span data-stu-id="f0005-102">Customizing Permissions with Impersonation in SQL Server</span></span>

<span data-ttu-id="f0005-103">Viele Anwendungen verwenden für den Zugriff auf Daten gespeicherte Prozeduren, wobei der Zugriff auf die Basistabellen per Besitzverkettung gesteuert wird.</span><span class="sxs-lookup"><span data-stu-id="f0005-103">Many applications use stored procedures to access data, relying on ownership chaining to restrict access to base tables.</span></span> <span data-ttu-id="f0005-104">Sie können EXECUTE-Berechtigungen für gespeicherte Prozeduren gewähren und so Berechtigungen für die Basistabellen widerrufen oder verweigern.</span><span class="sxs-lookup"><span data-stu-id="f0005-104">You can grant EXECUTE permissions on stored procedures, revoking or denying permissions on the base tables.</span></span> <span data-ttu-id="f0005-105">Wenn der Besitzer der gespeicherten Prozedur identisch mit dem Besitzer der Tabellen ist, nimmt SQL Server keine Prüfung der Berechtigungen des Aufrufers vor.</span><span class="sxs-lookup"><span data-stu-id="f0005-105">SQL Server does not check the permissions of the caller if the stored procedure and tables have the same owner.</span></span> <span data-ttu-id="f0005-106">Bei Objekten, die verschiedenen Besitzern gehören, und bei dynamischem SQL funktioniert die Besitzverkettung jedoch nicht.</span><span class="sxs-lookup"><span data-stu-id="f0005-106">However, ownership chaining doesn't work if objects have different owners or in the case of dynamic SQL.</span></span>  
  
 <span data-ttu-id="f0005-107">Sie können die EXECUTE AS-Klausel in einer gespeicherten Prozedur verwenden, wenn der Aufrufer keine Berechtigung für die Datenbankobjekte besitzt, auf die verwiesen wird.</span><span class="sxs-lookup"><span data-stu-id="f0005-107">You can use the EXECUTE AS clause in a stored procedure when the caller doesn't have permissions on the referenced database objects.</span></span> <span data-ttu-id="f0005-108">Durch die EXECUTE AS-Klausel geht der Ausführungskontext auf den Proxybenutzer über.</span><span class="sxs-lookup"><span data-stu-id="f0005-108">The effect of the EXECUTE AS clause is that the execution context is switched to the proxy user.</span></span> <span data-ttu-id="f0005-109">Sämtlicher Code sowie alle Aufrufe geschachtelter gespeicherter Prozeduren oder Trigger werden im Sicherheitskontext des Proxybenutzers ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="f0005-109">All code, as well as any calls to nested stored procedures or triggers, executes under the security context of the proxy user.</span></span> <span data-ttu-id="f0005-110">Der Ausführungskontext wird erst nach Ausführung der Prozedur oder bei Ausführung einer REVERT-Anweisung auf den ursprünglichen Aufrufer zurückgesetzt.</span><span class="sxs-lookup"><span data-stu-id="f0005-110">Execution context is reverted to the original caller only after execution of the procedure or when a REVERT statement is issued.</span></span>  
  
## <a name="context-switching-with-the-execute-as-statement"></a><span data-ttu-id="f0005-111">Kontextwechsel mit der EXECUTE AS-Anweisung</span><span class="sxs-lookup"><span data-stu-id="f0005-111">Context Switching with the EXECUTE AS Statement</span></span>  

 <span data-ttu-id="f0005-112">Mit der Transact-SQL-EXECUTE AS-Anweisung können Sie den Ausführungskontext einer Anweisung wechseln, indem ein Identitätswechsel zu einer anderen Anmeldung oder einem anderen Datenbankbenutzer erfolgt.</span><span class="sxs-lookup"><span data-stu-id="f0005-112">The Transact-SQL EXECUTE AS statement allows you to switch the execution context of a statement by impersonating another login or database user.</span></span> <span data-ttu-id="f0005-113">Diese Vorgehensweise empfiehlt sich, wenn Abfragen und Prozeduren unter einem anderen Benutzernamen getestet werden sollen.</span><span class="sxs-lookup"><span data-stu-id="f0005-113">This is a useful technique for testing queries and procedures as another user.</span></span>  
  
```sql  
EXECUTE AS LOGIN = 'loginName';  
EXECUTE AS USER = 'userName';  
```  
  
 <span data-ttu-id="f0005-114">Sie müssen IMPERSONATE-Berechtigungen für die Anmeldung oder den Benutzer besitzen, mit dessen Identität Sie auftreten möchten.</span><span class="sxs-lookup"><span data-stu-id="f0005-114">You must have IMPERSONATE permissions on the login or user you are impersonating.</span></span> <span data-ttu-id="f0005-115">Benutzer mit der `sysadmin`-Rolle haben per se IMPERSONATE-Berechtigungen für alle Datenbanken, und für Benutzer mit der `db_owner`-Rolle gelten diese Berechtigungen für die Datenbanken, deren Besitzer sie sind.</span><span class="sxs-lookup"><span data-stu-id="f0005-115">This permission is implied for `sysadmin` for all databases, and `db_owner` role members in databases that they own.</span></span>  
  
## <a name="granting-permissions-with-the-execute-as-clause"></a><span data-ttu-id="f0005-116">Gewähren von Berechtigungen mit der EXECUTE AS-Klausel</span><span class="sxs-lookup"><span data-stu-id="f0005-116">Granting Permissions with the EXECUTE AS Clause</span></span>  

 <span data-ttu-id="f0005-117">Sie können die EXECUTE AS-Klausel im Definitionsheader einer gespeicherten Prozedur, eines Triggers oder einer benutzerdefinierten Funktion (nicht aber in Inline-Tabellenwertfunktionen) verwenden.</span><span class="sxs-lookup"><span data-stu-id="f0005-117">You can use the EXECUTE AS clause in the definition header of a stored procedure, trigger, or user-defined function (except for inline table-valued functions).</span></span> <span data-ttu-id="f0005-118">Die Prozedur wird dann im Kontext des Benutzernamens oder Schlüsselworts ausgeführt, der oder das in der EXECUTE AS-Klausel angegeben ist.</span><span class="sxs-lookup"><span data-stu-id="f0005-118">This causes the procedure to execute in the context of the user name or keyword specified in the EXECUTE AS clause.</span></span> <span data-ttu-id="f0005-119">Sie können einen Proxybenutzer in der Datenbank erstellen, der keiner Anmeldung zugeordnet ist, indem Sie ihm nur die erforderlichen Berechtigungen für die Objekte gewähren, auf die die Prozedur zugreift.</span><span class="sxs-lookup"><span data-stu-id="f0005-119">You can create a proxy user in the database that is not mapped to a login, granting it only the necessary permissions on the objects accessed by the procedure.</span></span> <span data-ttu-id="f0005-120">Nur der in der EXECUTE AS-Klausel angegebene Proxybenutzer muss eine Berechtigung für alle Objekte besitzen, auf die das Modul zugreift.</span><span class="sxs-lookup"><span data-stu-id="f0005-120">Only the proxy user specified in the EXECUTE AS clause must have permissions on all objects accessed by the module.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="f0005-121">Einige Aktionen, z. B. TRUNCATE TABLE, besitzen keine Berechtigungen, die gewährt werden können.</span><span class="sxs-lookup"><span data-stu-id="f0005-121">Some actions, such as TRUNCATE TABLE, do not have grantable permissions.</span></span> <span data-ttu-id="f0005-122">Durch Integrieren der Anweisung in eine Prozedur und Angeben eines Proxybenutzers, der ALTER TABLE-Berechtigungen besitzt, können Sie die Berechtigungen so erweitern, dass die Tabelle für die Aufrufer, die nur EXECUTE-Berechtigungen für die Prozedur besitzen, abgeschnitten wird.</span><span class="sxs-lookup"><span data-stu-id="f0005-122">By incorporating the statement within a procedure and specifying a proxy user who has ALTER TABLE permissions, you can extend the permissions to truncate the table to callers who have only EXECUTE permissions on the procedure.</span></span>  
  
 <span data-ttu-id="f0005-123">Der in der EXECUTE AS-Klausel angegebene Kontext ist für die Dauer der Prozedur, einschließlich der geschachtelten Prozeduren und Trigger, gültig.</span><span class="sxs-lookup"><span data-stu-id="f0005-123">The context specified in the EXECUTE AS clause is valid for the duration of the procedure, including nested procedures and triggers.</span></span> <span data-ttu-id="f0005-124">Nach Abschluss der Ausführung oder bei Ausgabe der REVERT-Anweisung wechselt der Kontext wieder zum Aufrufer zurück.</span><span class="sxs-lookup"><span data-stu-id="f0005-124">Context reverts to the caller when execution is complete or the REVERT statement is issued.</span></span>  
  
 <span data-ttu-id="f0005-125">Für die Aufnahme der EXECUTE AS-Klausel in eine Prozedur sind die folgenden drei Schritte auszuführen.</span><span class="sxs-lookup"><span data-stu-id="f0005-125">There are three steps involved in using the EXECUTE AS clause in a procedure.</span></span>  
  
1. <span data-ttu-id="f0005-126">Erstellen Sie einen Proxybenutzer in der Datenbank, der keiner Anmeldung zugeordnet wird.</span><span class="sxs-lookup"><span data-stu-id="f0005-126">Create a proxy user in the database that is not mapped to a login.</span></span> <span data-ttu-id="f0005-127">Dieser Schritt ist nicht zwingend erforderlich, erleichtert aber das Verwalten der Berechtigungen.</span><span class="sxs-lookup"><span data-stu-id="f0005-127">This is not required, but it helps when managing permissions.</span></span>  
  
```sql
CREATE USER proxyUser WITHOUT LOGIN  
```  
  
1. <span data-ttu-id="f0005-128">Gewähren Sie dem Proxybenutzer die notwendigen Berechtigungen.</span><span class="sxs-lookup"><span data-stu-id="f0005-128">Grant the proxy user the necessary permissions.</span></span>  
  
2. <span data-ttu-id="f0005-129">Fügen Sie der gespeicherten Prozedur oder der benutzerdefinierten Funktion die EXECUTE AS-Klausel hinzu.</span><span class="sxs-lookup"><span data-stu-id="f0005-129">Add the EXECUTE AS clause to the stored procedure or user-defined function.</span></span>  
  
```sql
CREATE PROCEDURE [procName] WITH EXECUTE AS 'proxyUser' AS ...  
```  
  
> [!NOTE]
> <span data-ttu-id="f0005-130">Anwendungen, die eine Überwachung erfordern, können abgebrochen werden, da der ursprüngliche Sicherheitskontext des Aufrufers nicht beibehalten wird.</span><span class="sxs-lookup"><span data-stu-id="f0005-130">Applications that require auditing can break because the original security context of the caller is not retained.</span></span> <span data-ttu-id="f0005-131">Integrierte Funktionen, die die Identität des aktuellen Benutzers zurückgeben, z. B. SESSION_USER, USER oder USER_NAME, geben den mit der EXECUTE AS-Klausel verknüpften Benutzer und nicht den ursprünglichen Aufrufer zurück.</span><span class="sxs-lookup"><span data-stu-id="f0005-131">Built-in functions that return the identity of the current user, such as SESSION_USER, USER, or USER_NAME, return the user associated with the EXECUTE AS clause, not the original caller.</span></span>  
  
### <a name="using-execute-as-with-revert"></a><span data-ttu-id="f0005-132">Verwenden von EXECUTE AS mit REVERT</span><span class="sxs-lookup"><span data-stu-id="f0005-132">Using EXECUTE AS with REVERT</span></span>  

 <span data-ttu-id="f0005-133">Mit der Transact-SQL-REVERT-Anweisung  können Sie zum ursprünglichen Ausführungskontext zurückkehren.</span><span class="sxs-lookup"><span data-stu-id="f0005-133">You can use the Transact-SQL REVERT statement to revert to the original execution context.</span></span>  
  
 <span data-ttu-id="f0005-134">Mit der optionalen-Klausel ohne Revert Cookie = @variableName kann der Ausführungs Kontext zurück zum Aufrufer gewechselt werden, wenn die @variableName Variable den korrekten Wert enthält.</span><span class="sxs-lookup"><span data-stu-id="f0005-134">The optional clause, WITH NO REVERT COOKIE = @variableName, allows you switch the execution context back to the caller if the @variableName variable contains the correct value.</span></span> <span data-ttu-id="f0005-135">Auf diese Weise kann der Ausführungskontext in Umgebungen, in denen Verbindungspooling verwendet wird, wieder an den Aufrufer zurückgegeben werden.</span><span class="sxs-lookup"><span data-stu-id="f0005-135">This allows you to switch the execution context back to the caller in environments where connection pooling is used.</span></span> <span data-ttu-id="f0005-136">Da der Wert von @variableName nur dem Aufrufer der EXECUTE AS-Anweisung bekannt ist, kann der Aufrufer sicherstellen, dass der Ausführungs Kontext vom Endbenutzer, der die Anwendung aufruft, nicht geändert werden kann.</span><span class="sxs-lookup"><span data-stu-id="f0005-136">Because the value of @variableName is known only to the caller of the EXECUTE AS statement, the caller can guarantee that the execution context cannot be changed by the end user that invokes the application.</span></span> <span data-ttu-id="f0005-137">Beim Schließen wird die Verbindung an den Pool zurückgegeben.</span><span class="sxs-lookup"><span data-stu-id="f0005-137">When the connection is closed, it is returned to the pool.</span></span> <span data-ttu-id="f0005-138">Weitere Informationen zum Verbindungspooling in ADO.net finden Sie unter [SQL Server Verbindungspooling (ADO.net)](../sql-server-connection-pooling.md).</span><span class="sxs-lookup"><span data-stu-id="f0005-138">For more information on connection pooling in ADO.NET, see [SQL Server Connection Pooling (ADO.NET)](../sql-server-connection-pooling.md).</span></span>  
  
### <a name="specifying-the-execution-context"></a><span data-ttu-id="f0005-139">Angeben des Ausführungskontexts</span><span class="sxs-lookup"><span data-stu-id="f0005-139">Specifying the Execution Context</span></span>  

 <span data-ttu-id="f0005-140">Neben dem Angeben eines Benutzers können Sie EXECUTE AS auch zusammen mit den folgenden Schlüsselwörtern verwenden.</span><span class="sxs-lookup"><span data-stu-id="f0005-140">In addition to specifying a user, you can also use EXECUTE AS with any of the following keywords.</span></span>  
  
- <span data-ttu-id="f0005-141">CALLER:</span><span class="sxs-lookup"><span data-stu-id="f0005-141">CALLER.</span></span> <span data-ttu-id="f0005-142">Das Ausführen als CALLER ist die Standardeinstellung. Wenn nichts anderes angegeben ist, wird die Prozedur im Sicherheitskontext des Aufrufers ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="f0005-142">Executing as CALLER is the default; if no other option is specified, then the procedure executes in the security context of the caller.</span></span>  
  
- <span data-ttu-id="f0005-143">OWNER:</span><span class="sxs-lookup"><span data-stu-id="f0005-143">OWNER.</span></span> <span data-ttu-id="f0005-144">Mit OWNER wird die Prozedur im Kontext des Prozedurbesitzers ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="f0005-144">Executing as OWNER executes the procedure in the context of the procedure owner.</span></span> <span data-ttu-id="f0005-145">Wenn die Prozedur in einem Schema erstellt wird, dessen Besitzer der Datenbankbesitzer (`dbo`) ist, wird die Prozedur mit uneingeschränkten Berechtigungen ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="f0005-145">If the procedure is created in a schema owned by `dbo` or the database owner, the procedure will execute with unrestricted permissions.</span></span>  
  
- <span data-ttu-id="f0005-146">SELF:</span><span class="sxs-lookup"><span data-stu-id="f0005-146">SELF.</span></span> <span data-ttu-id="f0005-147">Mit SELF wird die Prozedur im Sicherheitskontext des Erstellers der gespeicherten Prozedur ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="f0005-147">Executing as SELF executes in the security context of the creator of the stored procedure.</span></span> <span data-ttu-id="f0005-148">Dies entspricht der Ausführung der Prozedur als ein spezifischer Benutzer, wobei der spezifische Benutzer die Person ist, die die Prozedur erstellt oder geändert hat.</span><span class="sxs-lookup"><span data-stu-id="f0005-148">This is equivalent to executing as a specified user, where the specified user is the person creating or altering the procedure.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="f0005-149">Weitere Informationen</span><span class="sxs-lookup"><span data-stu-id="f0005-149">See also</span></span>

- [<span data-ttu-id="f0005-150">Sichern von ADO.NET-Anwendungen</span><span class="sxs-lookup"><span data-stu-id="f0005-150">Securing ADO.NET Applications</span></span>](../securing-ado-net-applications.md)
- [<span data-ttu-id="f0005-151">Übersicht über die SQL Server-Sicherheit</span><span class="sxs-lookup"><span data-stu-id="f0005-151">Overview of SQL Server Security</span></span>](overview-of-sql-server-security.md)
- [<span data-ttu-id="f0005-152">Anwendungssicherheitsszenarios in SQL Server</span><span class="sxs-lookup"><span data-stu-id="f0005-152">Application Security Scenarios in SQL Server</span></span>](application-security-scenarios-in-sql-server.md)
- [<span data-ttu-id="f0005-153">Verwalten von Berechtigungen mit gespeicherten Prozeduren in SQL Server</span><span class="sxs-lookup"><span data-stu-id="f0005-153">Managing Permissions with Stored Procedures in SQL Server</span></span>](managing-permissions-with-stored-procedures-in-sql-server.md)
- [<span data-ttu-id="f0005-154">Schreiben von sicherem dynamischem SQL in SQL Server</span><span class="sxs-lookup"><span data-stu-id="f0005-154">Writing Secure Dynamic SQL in SQL Server</span></span>](writing-secure-dynamic-sql-in-sql-server.md)
- [<span data-ttu-id="f0005-155">Signieren von gespeicherten Prozeduren in SQL Server</span><span class="sxs-lookup"><span data-stu-id="f0005-155">Signing Stored Procedures in SQL Server</span></span>](signing-stored-procedures-in-sql-server.md)
- [<span data-ttu-id="f0005-156">Ändern von Daten mit gespeicherten Prozeduren</span><span class="sxs-lookup"><span data-stu-id="f0005-156">Modifying Data with Stored Procedures</span></span>](../modifying-data-with-stored-procedures.md)
- [<span data-ttu-id="f0005-157">Übersicht über ADO.NET</span><span class="sxs-lookup"><span data-stu-id="f0005-157">ADO.NET Overview</span></span>](../ado-net-overview.md)
