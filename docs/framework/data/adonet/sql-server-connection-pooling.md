---
title: Verbindungs Pooling für SQL Server
description: Erfahren Sie, wie ADO.net die Kosten für das Öffnen von Verbindungen mithilfe SQL Server Verbindungspooling minimiert, wodurch der Aufwand für neue Verbindungen reduziert wird.
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 7e51d44e-7c4e-4040-9332-f0190fe36f07
ms.openlocfilehash: 96d9e9a7e43f71dc30bd2d7a7f1902238941d471
ms.sourcegitcommit: 5b475c1855b32cf78d2d1bbb4295e4c236f39464
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 09/24/2020
ms.locfileid: "91156354"
---
# <a name="sql-server-connection-pooling-adonet"></a><span data-ttu-id="bc831-103">SQL Server-Verbindungspooling (ADO.NET)</span><span class="sxs-lookup"><span data-stu-id="bc831-103">SQL Server Connection Pooling (ADO.NET)</span></span>

<span data-ttu-id="bc831-104">Beim Herstellen einer Verbindung mit einem Datenbankserver müssen normalerweise mehrere zeitaufwändige Schritte ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="bc831-104">Connecting to a database server typically consists of several time-consuming steps.</span></span> <span data-ttu-id="bc831-105">Es muss u. a. ein physischer Channel (z. B. ein Socket oder eine benannte Pipe) erstellt, der anfängliche Handshake durchgeführt, die Informationen der Verbindungszeichenfolge analysiert, die Verbindung vom Server authentifiziert und Überprüfungen zum Eintragen in die aktuelle Transaktion ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="bc831-105">A physical channel such as a socket or a named pipe must be established, the initial handshake with the server must occur, the connection string information must be parsed, the connection must be authenticated by the server, checks must be run for enlisting in the current transaction, and so on.</span></span>  
  
 <span data-ttu-id="bc831-106">In der Praxis verwenden die meisten Anwendungen nur eine oder einige unterschiedliche Konfigurationen für Verbindungen.</span><span class="sxs-lookup"><span data-stu-id="bc831-106">In practice, most applications use only one or a few different configurations for connections.</span></span> <span data-ttu-id="bc831-107">Dies bedeutet, dass beim Ausführen von Anwendungen viele identische Verbindungen wiederholt geöffnet und geschlossen werden.</span><span class="sxs-lookup"><span data-stu-id="bc831-107">This means that during application execution, many identical connections will be repeatedly opened and closed.</span></span> <span data-ttu-id="bc831-108">Um die Kosten für das Öffnen von Verbindungen zu minimieren, verwendet ADO.net eine Optimierungstechnik namens *Verbindungspooling*.</span><span class="sxs-lookup"><span data-stu-id="bc831-108">To minimize the cost of opening connections, ADO.NET uses an optimization technique called *connection pooling*.</span></span>  
  
 <span data-ttu-id="bc831-109">Beim Verbindungspooling wird die Häufigkeit reduziert, mit der neue Verbindungen hergestellt werden müssen.</span><span class="sxs-lookup"><span data-stu-id="bc831-109">Connection pooling reduces the number of times that new connections must be opened.</span></span> <span data-ttu-id="bc831-110">Der *Pool Funktion* behält den Besitz der physischen Verbindung bei.</span><span class="sxs-lookup"><span data-stu-id="bc831-110">The *pooler* maintains ownership of the physical connection.</span></span> <span data-ttu-id="bc831-111">Er verwaltet Verbindungen, indem er eine Reihe aktiver Verbindungen für jede angegebene Verbindungskonfiguration beibehält.</span><span class="sxs-lookup"><span data-stu-id="bc831-111">It manages connections by keeping alive a set of active connections for each given connection configuration.</span></span> <span data-ttu-id="bc831-112">Sobald ein Benutzer `Open` für eine Verbindung aufruft, sucht der Pooler nach einer verfügbaren Verbindung im Pool.</span><span class="sxs-lookup"><span data-stu-id="bc831-112">Whenever a user calls `Open` on a connection, the pooler looks for an available connection in the pool.</span></span> <span data-ttu-id="bc831-113">Wenn eine Verbindung in einem Pool verfügbar ist, gibt der Pooler die Verbindung an den Aufrufer zurück, anstatt eine neue Verbindung herzustellen.</span><span class="sxs-lookup"><span data-stu-id="bc831-113">If a pooled connection is available, it returns it to the caller instead of opening a new connection.</span></span> <span data-ttu-id="bc831-114">Wenn die Anwendung `Close` für eine Verbindung aufruft, wird diese vom Pooler an die aktiven Verbindungen im Pool zurückgegeben, anstatt diese zu beenden.</span><span class="sxs-lookup"><span data-stu-id="bc831-114">When the application calls `Close` on the connection, the pooler returns it to the pooled set of active connections instead of closing it.</span></span> <span data-ttu-id="bc831-115">Nachdem die Verbindung an den Pool zurückgegeben wurde, kann sie für den nächsten `Open`-Aufruf erneut verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="bc831-115">Once the connection is returned to the pool, it is ready to be reused on the next `Open` call.</span></span>  
  
 <span data-ttu-id="bc831-116">Es können nur Verbindungen mit derselben Konfiguration zu einem Pool zusammengefasst werden.</span><span class="sxs-lookup"><span data-stu-id="bc831-116">Only connections with the same configuration can be pooled.</span></span> <span data-ttu-id="bc831-117">ADO.net behält mehrere Pools gleichzeitig bei, einen für jede Konfiguration.</span><span class="sxs-lookup"><span data-stu-id="bc831-117">ADO.NET keeps several pools at the same time, one for each configuration.</span></span> <span data-ttu-id="bc831-118">Verbindungen werden durch Verbindungszeichenfolgen sowie bei Verwendung der integrierten Sicherheit durch Windows-Identitäten in Pools unterteilt.</span><span class="sxs-lookup"><span data-stu-id="bc831-118">Connections are separated into pools by connection string, and by Windows identity when integrated security is used.</span></span> <span data-ttu-id="bc831-119">Verbindungen werden auch auf der Basis ihrer Eintragung in eine Transaktion zu einem Pool zusammengefasst.</span><span class="sxs-lookup"><span data-stu-id="bc831-119">Connections are also pooled based on whether they are enlisted in a transaction.</span></span> <span data-ttu-id="bc831-120">Bei Verwendung von <xref:System.Data.SqlClient.SqlConnection.ChangePassword%2A> wirkt sich die <xref:System.Data.SqlClient.SqlCredential>-Instanz auf den Verbindungspool aus.</span><span class="sxs-lookup"><span data-stu-id="bc831-120">When using <xref:System.Data.SqlClient.SqlConnection.ChangePassword%2A>, the <xref:System.Data.SqlClient.SqlCredential> instance affects the connection pool.</span></span> <span data-ttu-id="bc831-121">Verschiedene Instanzen von <xref:System.Data.SqlClient.SqlCredential> verwenden verschiedene Verbindungspools, auch wenn die Benutzer-ID und das Kennwort übereinstimmen.</span><span class="sxs-lookup"><span data-stu-id="bc831-121">Different instances of <xref:System.Data.SqlClient.SqlCredential> will use different connection pools, even if the user ID and password are the same.</span></span>  
  
 <span data-ttu-id="bc831-122">Durch Verbindungspooling kann die Leistung und Skalierbarkeit einer Anwendung wesentlich erhöht werden.</span><span class="sxs-lookup"><span data-stu-id="bc831-122">Pooling connections can significantly enhance the performance and scalability of your application.</span></span> <span data-ttu-id="bc831-123">Standardmäßig ist das Verbindungspooling in ADO.NET aktiviert.</span><span class="sxs-lookup"><span data-stu-id="bc831-123">By default, connection pooling is enabled in ADO.NET.</span></span> <span data-ttu-id="bc831-124">Verbindungen werden beim Öffnen und Schließen in der Anwendung vom Pooler optimiert, außer wenn dies explizit deaktiviert wurde.</span><span class="sxs-lookup"><span data-stu-id="bc831-124">Unless you explicitly disable it, the pooler optimizes the connections as they are opened and closed in your application.</span></span> <span data-ttu-id="bc831-125">Sie können auch mehrere Modifizierer für Verbindungszeichenfolgen angeben, um das Verhalten des Verbindungspoolings zu steuern.</span><span class="sxs-lookup"><span data-stu-id="bc831-125">You can also supply several connection string modifiers to control connection pooling behavior.</span></span> <span data-ttu-id="bc831-126">Weitere Informationen hierzu finden Sie weiter unten im Abschnitt "Steuern des Verbindungspoolings mit Schlüsselwörtern für Verbindungszeichenfolgen".</span><span class="sxs-lookup"><span data-stu-id="bc831-126">For more information, see "Controlling Connection Pooling with Connection String Keywords" later in this topic.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="bc831-127">Wenn das Verbindungspooling aktiviert ist und ein Timeout- oder anderer Anmeldefehler auftritt, wird eine Ausnahme ausgelöst, und nachfolgende Verbindungsversuche innerhalb der folgenden fünf Sekunden, der "Sperrfrist", schlagen fehl.</span><span class="sxs-lookup"><span data-stu-id="bc831-127">When connection pooling is enabled, and if a timeout error or other login error occurs, an exception will be thrown and subsequent connection attempts will fail for the next five seconds, the "blocking period".</span></span> <span data-ttu-id="bc831-128">Wenn die Anwendung versucht, innerhalb der Sperrfrist eine Verbindung herzustellen, wird die erste Ausnahme erneut ausgelöst.</span><span class="sxs-lookup"><span data-stu-id="bc831-128">If the application attempts to connect within the blocking period, the first exception will be thrown again.</span></span> <span data-ttu-id="bc831-129">Nachfolgende Fehler nach Ende einer Sperrfrist führen zu neuen Sperrfristen, die doppelt so lang sind wie die vorherige Sperrfrist (maximal eine Minute).</span><span class="sxs-lookup"><span data-stu-id="bc831-129">Subsequent failures after a blocking period ends will result in a new blocking periods that is twice as long as the previous blocking period, up to a maximum of one minute.</span></span>  
  
## <a name="pool-creation-and-assignment"></a><span data-ttu-id="bc831-130">Erstellen und Zuweisen von Pools</span><span class="sxs-lookup"><span data-stu-id="bc831-130">Pool Creation and Assignment</span></span>  

 <span data-ttu-id="bc831-131">Wenn eine Verbindung erstmals hergestellt wird, wird ein Verbindungspool basierend auf einem exakt übereinstimmenden Algorithmus erstellt. Damit wird der Pool der Verbindungszeichenfolge in der Verbindung zugewiesen.</span><span class="sxs-lookup"><span data-stu-id="bc831-131">When a connection is first opened, a connection pool is created based on an exact matching algorithm that associates the pool with the connection string in the connection.</span></span> <span data-ttu-id="bc831-132">Jedem Verbindungspool wird eine eindeutige Verbindungszeichenfolge zugeordnet.</span><span class="sxs-lookup"><span data-stu-id="bc831-132">Each connection pool is associated with a distinct connection string.</span></span> <span data-ttu-id="bc831-133">Wenn beim Öffnen einer neuen Verbindung die Verbindungszeichenfolge nicht genau mit einem vorhanden Pool übereinstimmt, wird ein neuer Pool erstellt.</span><span class="sxs-lookup"><span data-stu-id="bc831-133">When a new connection is opened, if the connection string is not an exact match to an existing pool, a new pool is created.</span></span> <span data-ttu-id="bc831-134">Verbindungen werden pro Prozess, pro Anwendungsdomäne, pro Verbindungszeichenfolge und bei Verwendung der integrierten Sicherheit pro Windows-Identität in einem Pool zusammengefasst.</span><span class="sxs-lookup"><span data-stu-id="bc831-134">Connections are pooled per process, per application domain, per connection string and when integrated security is used, per Windows identity.</span></span> <span data-ttu-id="bc831-135">Verbindungszeichenfolgen müssen ebenfalls exakt übereinstimmen. Schlüsselwörter, die für dieselbe Verbindung in einer anderen Reihenfolge bereitgestellt werden, werden in separaten Pools zusammengefasst.</span><span class="sxs-lookup"><span data-stu-id="bc831-135">Connection strings must also be an exact match; keywords supplied in a different order for the same connection will be pooled separately.</span></span>  
  
 <span data-ttu-id="bc831-136">Im folgenden C#-Beispiel werden drei neue <xref:System.Data.SqlClient.SqlConnection>-Objekte erstellt. Es sind aber nur zwei Verbindungspools erforderlich, um diese Objekte zu verwalten.</span><span class="sxs-lookup"><span data-stu-id="bc831-136">In the following C# example, three new <xref:System.Data.SqlClient.SqlConnection> objects are created, but only two connection pools are required to manage them.</span></span> <span data-ttu-id="bc831-137">Beachten Sie, dass die erste und zweite Verbindungszeichenfolge sich durch den Wert unterscheiden, der `Initial Catalog` zugewiesen ist.</span><span class="sxs-lookup"><span data-stu-id="bc831-137">Note that the first and second connection strings differ by the value assigned for `Initial Catalog`.</span></span>  
  
```csharp
using (SqlConnection connection = new SqlConnection(  
  "Integrated Security=SSPI;Initial Catalog=Northwind"))  
    {  
        connection.Open();
        // Pool A is created.  
    }  
  
using (SqlConnection connection = new SqlConnection(  
  "Integrated Security=SSPI;Initial Catalog=pubs"))  
    {  
        connection.Open();
        // Pool B is created because the connection strings differ.  
    }  
  
using (SqlConnection connection = new SqlConnection(  
  "Integrated Security=SSPI;Initial Catalog=Northwind"))  
    {  
        connection.Open();
        // The connection string matches pool A.  
    }  
```  
  
 <span data-ttu-id="bc831-138">Wenn die `MinPoolSize` nicht in der Verbindungszeichenfolge oder als 0 (null) angegeben ist, wird der Pool nach einer bestimmten Zeit der Inaktivität geschlossen.</span><span class="sxs-lookup"><span data-stu-id="bc831-138">If `MinPoolSize` is either not specified in the connection string or is specified as zero, the connections in the pool will be closed after a period of inactivity.</span></span> <span data-ttu-id="bc831-139">Wenn die angegebene `MinPoolSize` größer als 0 (null) ist, wird der Verbindungspool erst gelöscht, nachdem die `AppDomain` entladen und der Prozess beendet wurde.</span><span class="sxs-lookup"><span data-stu-id="bc831-139">However, if the specified `MinPoolSize` is greater than zero, the connection pool is not destroyed until the `AppDomain` is unloaded and the process ends.</span></span> <span data-ttu-id="bc831-140">Für die Pflege inaktiver oder leerer Pools ist ein minimaler Systemmehraufwand erforderlich.</span><span class="sxs-lookup"><span data-stu-id="bc831-140">Maintenance of inactive or empty pools involves minimal system overhead.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="bc831-141">Der Pool wird bei schwerwiegenden Fehlern (z. B. einem Failover) automatisch gelöscht.</span><span class="sxs-lookup"><span data-stu-id="bc831-141">The pool is automatically cleared when a fatal error occurs, such as a failover.</span></span>  
  
## <a name="adding-connections"></a><span data-ttu-id="bc831-142">Hinzufügen von Verbindungen</span><span class="sxs-lookup"><span data-stu-id="bc831-142">Adding Connections</span></span>  

 <span data-ttu-id="bc831-143">Für jede eindeutige Verbindungszeichenfolge wird ein Verbindungspool erstellt.</span><span class="sxs-lookup"><span data-stu-id="bc831-143">A connection pool is created for each unique connection string.</span></span> <span data-ttu-id="bc831-144">Wenn ein Pool erstellt wird, werden mehrere Verbindungsobjekte erstellt und dem Pool hinzugefügt wird, sodass die minimalen Anforderungen für die Größe eines Pools erfüllt sind.</span><span class="sxs-lookup"><span data-stu-id="bc831-144">When a pool is created, multiple connection objects are created and added to the pool so that the minimum pool size requirement is satisfied.</span></span> <span data-ttu-id="bc831-145">Verbindungen werden dem Pool nach Bedarf hinzugefügt, bis die maximale Poolgröße (Standardwert: 100) erreicht ist.</span><span class="sxs-lookup"><span data-stu-id="bc831-145">Connections are added to the pool as needed, up to the maximum pool size specified (100 is the default).</span></span> <span data-ttu-id="bc831-146">Verbindungen werden wieder für den Pool freigegeben, wenn sie geschlossen oder verworfen werden.</span><span class="sxs-lookup"><span data-stu-id="bc831-146">Connections are released back into the pool when they are closed or disposed.</span></span>  
  
 <span data-ttu-id="bc831-147">Wenn ein <xref:System.Data.SqlClient.SqlConnection>-Objekt angefordert wird, wird es aus dem Pool abgerufen, wenn eine verwendbare Verbindung verfügbar ist.</span><span class="sxs-lookup"><span data-stu-id="bc831-147">When a <xref:System.Data.SqlClient.SqlConnection> object is requested, it is obtained from the pool if a usable connection is available.</span></span> <span data-ttu-id="bc831-148">Eine Verbindung ist dann verwendbar, wenn sie nicht verwendet wird, einen übereinstimmenden Transaktionskontext aufweist oder keinem Transaktionskontext zugeordnet ist sowie über eine gültige Verknüpfung zum Server verfügt.</span><span class="sxs-lookup"><span data-stu-id="bc831-148">To be usable, a connection must be unused, have a matching transaction context or be unassociated with any transaction context, and have a valid link to the server.</span></span>  
  
 <span data-ttu-id="bc831-149">Die Verbindungspoolfunktion erfüllt diese Verbindungsanforderungen, indem Verbindungen erneut zugewiesen werden, sobald sie wieder für den Pool freigegeben werden.</span><span class="sxs-lookup"><span data-stu-id="bc831-149">The connection pooler satisfies requests for connections by reallocating connections as they are released back into the pool.</span></span> <span data-ttu-id="bc831-150">Wenn die maximale Poolgröße erreicht ist und keine verwendbare Verbindung verfügbar ist, wird die Anforderung in die Warteschlange gestellt.</span><span class="sxs-lookup"><span data-stu-id="bc831-150">If the maximum pool size has been reached and no usable connection is available, the request is queued.</span></span> <span data-ttu-id="bc831-151">Der Pooler versucht anschließend, alle Verbindungen wieder anzufordern, bis das Timeout erreicht ist (der Standardwert beträgt 15 Sekunden).</span><span class="sxs-lookup"><span data-stu-id="bc831-151">The pooler then tries to reclaim any connections until the time-out is reached (the default is 15 seconds).</span></span> <span data-ttu-id="bc831-152">Wenn der Pooler die Anforderung nicht erfüllt, bevor das Zeitlimit für die Verbindung überschritten ist, wird eine Ausnahme ausgelöst.</span><span class="sxs-lookup"><span data-stu-id="bc831-152">If the pooler cannot satisfy the request before the connection times out, an exception is thrown.</span></span>  
  
> [!CAUTION]
> <span data-ttu-id="bc831-153">Es ist unbedingt zu empfehlen, die Verbindung nach Verwendung stets zu schließen, damit sie in den Pool zurückgegeben wird.</span><span class="sxs-lookup"><span data-stu-id="bc831-153">We strongly recommend that you always close the connection when you are finished using it so that the connection will be returned to the pool.</span></span> <span data-ttu-id="bc831-154">Hierzu können Sie entweder die- `Close` Methode oder die- `Dispose` Methode des-Objekts verwenden `Connection` oder alle Verbindungen innerhalb einer- `using` Anweisung in c# oder eine- `Using` Anweisung in Visual Basic öffnen.</span><span class="sxs-lookup"><span data-stu-id="bc831-154">You can do this using either the `Close` or `Dispose` methods of the `Connection` object, or by opening all connections inside a `using` statement in C#, or a `Using` statement in Visual Basic.</span></span> <span data-ttu-id="bc831-155">Verbindungen, die nicht explizit geschlossen werden, werden möglicherweise dem Pool nicht hinzugefügt bzw. nicht an den Pool zurückgegeben.</span><span class="sxs-lookup"><span data-stu-id="bc831-155">Connections that are not explicitly closed might not be added or returned to the pool.</span></span> <span data-ttu-id="bc831-156">Weitere Informationen finden Sie unter [using-Anweisung](../../../csharp/language-reference/keywords/using-statement.md) oder Vorgehens [Weise: Verwerfen einer System Ressource](../../../visual-basic/programming-guide/language-features/control-flow/how-to-dispose-of-a-system-resource.md) für Visual Basic.</span><span class="sxs-lookup"><span data-stu-id="bc831-156">For more information, see [using Statement](../../../csharp/language-reference/keywords/using-statement.md) or [How to: Dispose of a System Resource](../../../visual-basic/programming-guide/language-features/control-flow/how-to-dispose-of-a-system-resource.md) for Visual Basic.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="bc831-157">Rufen Sie nicht `Close` oder `Dispose` für eine `Connection`, einen `DataReader` oder ein anderes verwaltetes Objekt in der `Finalize`-Methode der Klasse auf.</span><span class="sxs-lookup"><span data-stu-id="bc831-157">Do not call `Close` or `Dispose` on a `Connection`, a `DataReader`, or any other managed object in the `Finalize` method of your class.</span></span> <span data-ttu-id="bc831-158">Geben Sie in einer Finalize-Methode nur nicht verwaltete Ressourcen frei, die der Klasse direkt gehören.</span><span class="sxs-lookup"><span data-stu-id="bc831-158">In a finalizer, only release unmanaged resources that your class owns directly.</span></span> <span data-ttu-id="bc831-159">Wenn die Klasse keine nicht verwalteten Ressourcen besitzt, definieren Sie in der Klasse keine `Finalize`-Methode.</span><span class="sxs-lookup"><span data-stu-id="bc831-159">If your class does not own any unmanaged resources, do not include a `Finalize` method in your class definition.</span></span> <span data-ttu-id="bc831-160">Weitere Informationen finden Sie unter [Garbage Collection](../../../standard/garbage-collection/index.md).</span><span class="sxs-lookup"><span data-stu-id="bc831-160">For more information, see [Garbage Collection](../../../standard/garbage-collection/index.md).</span></span>  
  
<span data-ttu-id="bc831-161">Weitere Informationen zu den Ereignissen, die mit dem Öffnen und Schließen von Verbindungen verknüpft sind, finden Sie unter [Audit Login Event Class](/sql/relational-databases/event-classes/audit-login-event-class) und [Audit Logout Event Class](/sql/relational-databases/event-classes/audit-logout-event-class) in der SQL Server-Dokumentation.</span><span class="sxs-lookup"><span data-stu-id="bc831-161">For more info about the events associated with opening and closing connections, see [Audit Login Event Class](/sql/relational-databases/event-classes/audit-login-event-class) and [Audit Logout Event Class](/sql/relational-databases/event-classes/audit-logout-event-class) in the SQL Server documentation.</span></span>  
  
## <a name="removing-connections"></a><span data-ttu-id="bc831-162">Entfernen von Verbindungen</span><span class="sxs-lookup"><span data-stu-id="bc831-162">Removing Connections</span></span>  

 <span data-ttu-id="bc831-163">Die Verbindungspoolfunktion entfernt eine Verbindung aus dem Pool, nachdem sie für eine Zeitspanne von etwa 4–8 Minuten nicht verwendet wurde oder wenn festgestellt wird, dass die Verbindung mit dem Server unterbrochen wurde.</span><span class="sxs-lookup"><span data-stu-id="bc831-163">The connection pooler removes a connection from the pool after it has been idle for approximately 4-8 minutes, or if the pooler detects that the connection with the server has been severed.</span></span> <span data-ttu-id="bc831-164">Beachten Sie, dass eine unterbrochene Verbindung nur nach einem Versuch, mit dem Server zu kommunizieren, festgestellt werden kann.</span><span class="sxs-lookup"><span data-stu-id="bc831-164">Note that a severed connection can be detected only after attempting to communicate with the server.</span></span> <span data-ttu-id="bc831-165">Wenn eine Verbindung gefunden wird, die nicht mehr mit dem Server verbunden ist, wird sie als ungültig markiert.</span><span class="sxs-lookup"><span data-stu-id="bc831-165">If a connection is found that is no longer connected to the server, it is marked as invalid.</span></span> <span data-ttu-id="bc831-166">Ungültige Verbindungen werden erst aus dem Verbindungspool entfernt, nachdem sie geschlossen oder freigegeben wurden.</span><span class="sxs-lookup"><span data-stu-id="bc831-166">Invalid connections are removed from the connection pool only when they are closed or reclaimed.</span></span>  
  
 <span data-ttu-id="bc831-167">Wenn eine Verbindung mit einem nicht mehr vorhandenen Server besteht, kann diese Verbindung aus dem Pool genommen werden, ohne dass die Verbindungspoolfunktion die unterbrochene Verbindung gefunden und als ungültig markiert hat.</span><span class="sxs-lookup"><span data-stu-id="bc831-167">If a connection exists to a server that has disappeared, this connection can be drawn from the pool even if the connection pooler has not detected the severed connection and marked it as invalid.</span></span> <span data-ttu-id="bc831-168">Dies liegt daran, dass durch den Mehraufwand beim Überprüfen, ob eine Verbindung noch gültig ist, die Vorteile eines Poolers umgangen werden, da eine weitere Schleife zum Server auftritt.</span><span class="sxs-lookup"><span data-stu-id="bc831-168">This is the case because the overhead of checking that the connection is still valid would eliminate the benefits of having a pooler by causing another round trip to the server to occur.</span></span> <span data-ttu-id="bc831-169">In diesem Fall wird bei der ersten Verwendung der Verbindung festgestellt, dass die Verbindung unterbrochen wurde, und es wird eine Ausnahme ausgelöst.</span><span class="sxs-lookup"><span data-stu-id="bc831-169">When this occurs, the first attempt to use the connection will detect that the connection has been severed, and an exception is thrown.</span></span>  
  
## <a name="clearing-the-pool"></a><span data-ttu-id="bc831-170">Löschen des Pools</span><span class="sxs-lookup"><span data-stu-id="bc831-170">Clearing the Pool</span></span>  

 <span data-ttu-id="bc831-171">ADO.NET 2,0 hat zwei neue Methoden eingeführt, um den Pool zu löschen: <xref:System.Data.SqlClient.SqlConnection.ClearAllPools%2A> und <xref:System.Data.SqlClient.SqlConnection.ClearPool%2A> .</span><span class="sxs-lookup"><span data-stu-id="bc831-171">ADO.NET 2.0 introduced two new methods to clear the pool: <xref:System.Data.SqlClient.SqlConnection.ClearAllPools%2A> and <xref:System.Data.SqlClient.SqlConnection.ClearPool%2A>.</span></span> <span data-ttu-id="bc831-172">`ClearAllPools` löscht die Verbindungspools für einen angegebenen Anbieter, und `ClearPool` löscht den Verbindungspool, der einer bestimmten Verbindung zugeordnet ist.</span><span class="sxs-lookup"><span data-stu-id="bc831-172">`ClearAllPools` clears the connection pools for a given provider, and `ClearPool` clears the connection pool that is associated with a specific connection.</span></span> <span data-ttu-id="bc831-173">Wenn Verbindungen während des Aufrufs verwendet werden, werden diese entsprechend markiert.</span><span class="sxs-lookup"><span data-stu-id="bc831-173">If there are connections being used at the time of the call, they are marked appropriately.</span></span> <span data-ttu-id="bc831-174">Sie werden nach dem Beenden verworfen und nicht an den Pool zurückgegeben.</span><span class="sxs-lookup"><span data-stu-id="bc831-174">When they are closed, they are discarded instead of being returned to the pool.</span></span>  
  
## <a name="transaction-support"></a><span data-ttu-id="bc831-175">Transaktionsunterstützung</span><span class="sxs-lookup"><span data-stu-id="bc831-175">Transaction Support</span></span>  

 <span data-ttu-id="bc831-176">Verbindungen werden aus dem Pool entnommen und basierend auf dem Transaktionskontext zugewiesen.</span><span class="sxs-lookup"><span data-stu-id="bc831-176">Connections are drawn from the pool and assigned based on transaction context.</span></span> <span data-ttu-id="bc831-177">Sofern `Enlist=false` in der Verbindungszeichenfolge angegeben ist, wird durch den Verbindungspool gewährleistet, dass die Verbindung im <xref:System.Transactions.Transaction.Current%2A>-Kontext eingetragen wird.</span><span class="sxs-lookup"><span data-stu-id="bc831-177">Unless `Enlist=false` is specified in the connection string, the connection pool makes sure that the connection is enlisted in the <xref:System.Transactions.Transaction.Current%2A> context.</span></span> <span data-ttu-id="bc831-178">Wenn eine Verbindung geschlossen und mit einer eingetragenen `System.Transactions`-Transaktion an den Pool zurückgegeben wird, wird sie so reserviert, dass bei der nächsten Anforderung für diesen Verbindungspool mit der gleichen `System.Transactions`-Transaktion die gleiche Verbindung zurückgegeben wird, soweit diese verfügbar ist.</span><span class="sxs-lookup"><span data-stu-id="bc831-178">When a connection is closed and returned to the pool with an enlisted `System.Transactions` transaction, it is set aside in such a way that the next request for that connection pool with the same `System.Transactions` transaction will return the same connection if it is available.</span></span> <span data-ttu-id="bc831-179">Wenn eine solche Anforderung ausgegeben wird und keine Verbindungen in einem Pool verfügbar sind, wird eine Verbindung vom nicht transaktiven Teil des Pools erstellt und eingetragen.</span><span class="sxs-lookup"><span data-stu-id="bc831-179">If such a request is issued, and there are no pooled connections available, a connection is drawn from the non-transacted part of the pool and enlisted.</span></span> <span data-ttu-id="bc831-180">Wenn in keinem Bereich des Pools Verbindungen verfügbar sind, wird eine neue Verbindung erstellt und eingetragen.</span><span class="sxs-lookup"><span data-stu-id="bc831-180">If no connections are available in either area of the pool, a new connection is created and enlisted.</span></span>  
  
 <span data-ttu-id="bc831-181">Wenn eine Verbindung geschlossen wird, wird sie an den Pool und an den entsprechenden Teilbereich auf der Grundlage des Transaktionskontexts zurückgegeben.</span><span class="sxs-lookup"><span data-stu-id="bc831-181">When a connection is closed, it is released back into the pool and into the appropriate subdivision based on its transaction context.</span></span> <span data-ttu-id="bc831-182">Sie können die Verbindung daher trennen, ohne einen Fehler zu generieren, auch wenn eine verteilte Transaktion noch aussteht.</span><span class="sxs-lookup"><span data-stu-id="bc831-182">Therefore, you can close the connection without generating an error, even though a distributed transaction is still pending.</span></span> <span data-ttu-id="bc831-183">So haben Sie die Möglichkeit, die verteilte Transaktion zu einem späteren Zeitpunkt durchzuführen oder abzubrechen.</span><span class="sxs-lookup"><span data-stu-id="bc831-183">This allows you to commit or abort the distributed transaction later.</span></span>  
  
## <a name="controlling-connection-pooling-with-connection-string-keywords"></a><span data-ttu-id="bc831-184">Steuern von Verbindungspooling mit Verbindungszeichenfolgen-Schlüsselwörtern</span><span class="sxs-lookup"><span data-stu-id="bc831-184">Controlling Connection Pooling with Connection String Keywords</span></span>  

 <span data-ttu-id="bc831-185">Die `ConnectionString`-Eigenschaft des <xref:System.Data.SqlClient.SqlConnection>-Objekts unterstützt Schlüssel-Wert-Paare für Verbindungszeichenfolgen, mit denen das Verhalten der Verbindungspoolinglogik angepasst werden kann.</span><span class="sxs-lookup"><span data-stu-id="bc831-185">The `ConnectionString` property of the <xref:System.Data.SqlClient.SqlConnection> object supports connection string key/value pairs that can be used to adjust the behavior of the connection pooling logic.</span></span> <span data-ttu-id="bc831-186">Weitere Informationen finden Sie unter <xref:System.Data.SqlClient.SqlConnection.ConnectionString%2A>.</span><span class="sxs-lookup"><span data-stu-id="bc831-186">For more information, see <xref:System.Data.SqlClient.SqlConnection.ConnectionString%2A>.</span></span>  
  
## <a name="pool-fragmentation"></a><span data-ttu-id="bc831-187">Poolfragmentierung</span><span class="sxs-lookup"><span data-stu-id="bc831-187">Pool Fragmentation</span></span>  

 <span data-ttu-id="bc831-188">Poolfragmentierung ist ein Problem, das häufig bei Webanwendungen auftritt, bei denen die Anwendung eine große Anzahl von Pools erstellen kann, die erst nach der Beendigung des Prozesses freigegeben werden.</span><span class="sxs-lookup"><span data-stu-id="bc831-188">Pool fragmentation is a common problem in many Web applications where the application can create a large number of pools that are not freed until the process exits.</span></span> <span data-ttu-id="bc831-189">Dabei bleibt eine große Anzahl von Verbindungen geöffnet. Dies benötigt viel Speicherplatz und verringert die Leistung.</span><span class="sxs-lookup"><span data-stu-id="bc831-189">This leaves a large number of connections open and consuming memory, which results in poor performance.</span></span>  
  
### <a name="pool-fragmentation-due-to-integrated-security"></a><span data-ttu-id="bc831-190">Poolfragmentierung aufgrund der integrierten Sicherheit</span><span class="sxs-lookup"><span data-stu-id="bc831-190">Pool Fragmentation Due to Integrated Security</span></span>  

 <span data-ttu-id="bc831-191">Verbindungen werden entsprechend der Verbindungszeichenfolge und der Benutzeridentität zu Pools zusammengefasst.</span><span class="sxs-lookup"><span data-stu-id="bc831-191">Connections are pooled according to the connection string plus the user identity.</span></span> <span data-ttu-id="bc831-192">Daher erhalten Sie einen Pool pro Benutzer, wenn Sie für die Website die Standardauthentifizierung oder die Windows-Authentifizierung und eine Anmeldung mit integrierter Sicherheit verwenden.</span><span class="sxs-lookup"><span data-stu-id="bc831-192">Therefore, if you use Basic authentication or Windows Authentication on the Web site and an integrated security login, you get one pool per user.</span></span> <span data-ttu-id="bc831-193">Obwohl dadurch die Leistungsfähigkeit nachfolgender Datenbankanforderungen für einen einzelnen Benutzer verbessert wird, kann der Benutzer von anderen Benutzern hergestellte Verbindungen nicht nutzen.</span><span class="sxs-lookup"><span data-stu-id="bc831-193">Although this improves the performance of subsequent database requests for a single user, that user cannot take advantage of connections made by other users.</span></span> <span data-ttu-id="bc831-194">Folglich wird pro Benutzer mindestens eine Verbindung mit dem Datenbankserver hergestellt.</span><span class="sxs-lookup"><span data-stu-id="bc831-194">It also results in at least one connection per user to the database server.</span></span> <span data-ttu-id="bc831-195">Dies ist ein Nebeneffekt einer bestimmten Webanwendungsarchitektur, den Entwickler gegen Sicherheits- und Überwachungsanforderungen abwägen müssen.</span><span class="sxs-lookup"><span data-stu-id="bc831-195">This is a side effect of a particular Web application architecture that developers must weigh against security and auditing requirements.</span></span>  
  
### <a name="pool-fragmentation-due-to-many-databases"></a><span data-ttu-id="bc831-196">Poolfragmentierung aufgrund vieler Datenbanken</span><span class="sxs-lookup"><span data-stu-id="bc831-196">Pool Fragmentation Due to Many Databases</span></span>  

 <span data-ttu-id="bc831-197">Viele Internetdienstanbieter hosten mehrere Websites auf einem einzigen Server.</span><span class="sxs-lookup"><span data-stu-id="bc831-197">Many Internet service providers host several Web sites on a single server.</span></span> <span data-ttu-id="bc831-198">Sie verwenden u. U. eine einzige Datenbank, um eine Anmeldung mit Forms-Authentifizierung zu bestätigen, und stellen anschließend für diesen Benutzer oder diese Gruppe von Benutzern eine Verbindung mit einer bestimmten Datenbank her.</span><span class="sxs-lookup"><span data-stu-id="bc831-198">They may use a single database to confirm a Forms authentication login and then open a connection to a specific database for that user or group of users.</span></span> <span data-ttu-id="bc831-199">Die Verbindung mit der Authentifizierungsdatenbank wird zu einem Pool zusammengefasst und kann von allen Benutzern verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="bc831-199">The connection to the authentication database is pooled and used by everyone.</span></span> <span data-ttu-id="bc831-200">Es besteht jedoch für jede Datenbank ein eigener Verbindungspool, wodurch die Anzahl von Verbindungen mit dem Server erhöht wird.</span><span class="sxs-lookup"><span data-stu-id="bc831-200">However, there is a separate pool of connections to each database, which increase the number of connections to the server.</span></span>  
  
 <span data-ttu-id="bc831-201">Dies ist auch ein Nebeneffekt des Anwendungsentwurfs.</span><span class="sxs-lookup"><span data-stu-id="bc831-201">This is also a side-effect of the application design.</span></span> <span data-ttu-id="bc831-202">Dieser Nebeneffekt kann relativ einfach vermieden werden, ohne dabei die Sicherheit beim Herstellen einer Verbindung mit SQL Server zu beeinträchtigen.</span><span class="sxs-lookup"><span data-stu-id="bc831-202">There is a relatively simple way to avoid this side effect without compromising security when you connect to SQL Server.</span></span> <span data-ttu-id="bc831-203">Stellen Sie keine Verbindung mit einer separaten Datenbank für jeden Benutzer oder jede Gruppe her, sondern stellen Sie eine Verbindung mit derselben Datenbank auf dem Server her, und führen Sie anschließend die Transact-SQL-Anweisung USE aus, um zur gewünschten Datenbank zu wechseln.</span><span class="sxs-lookup"><span data-stu-id="bc831-203">Instead of connecting to a separate database for each user or group, connect to the same database on the server and then execute the Transact-SQL USE statement to change to the desired database.</span></span> <span data-ttu-id="bc831-204">Im folgenden Codefragment wird das Herstellen einer Anfangsverbindung mit der `master`-Datenbank und der anschließende Wechsel zur gewünschten Datenbank in der `databaseName`-Zeichenfolgenvariable veranschaulicht.</span><span class="sxs-lookup"><span data-stu-id="bc831-204">The following code fragment demonstrates creating an initial connection to the `master` database and then switching to the desired database specified in the `databaseName` string variable.</span></span>  
  
```vb  
' Assumes that command is a valid SqlCommand object and that  
' connectionString connects to master.  
    command.Text = "USE DatabaseName"  
Using connection As New SqlConnection(connectionString)  
    connection.Open()  
    command.ExecuteNonQuery()  
End Using  
```  
  
```csharp  
// Assumes that command is a SqlCommand object and that  
// connectionString connects to master.  
command.Text = "USE DatabaseName";  
using (SqlConnection connection = new SqlConnection(  
  connectionString))  
  {  
    connection.Open();  
    command.ExecuteNonQuery();  
  }  
```  
  
## <a name="application-roles-and-connection-pooling"></a><span data-ttu-id="bc831-205">Anwendungsrollen und Verbindungspooling</span><span class="sxs-lookup"><span data-stu-id="bc831-205">Application Roles and Connection Pooling</span></span>  

 <span data-ttu-id="bc831-206">Nachdem eine Anwendungsrolle von SQL Server durch Aufrufen der im System gespeicherten Prozedur `sp_setapprole` aktiviert wurde, kann der Sicherheitskontext dieser Verbindung nicht zurückgesetzt werden.</span><span class="sxs-lookup"><span data-stu-id="bc831-206">After a SQL Server application role has been activated by calling the `sp_setapprole` system stored procedure, the security context of that connection cannot be reset.</span></span> <span data-ttu-id="bc831-207">Wenn jedoch das Verbindungspooling aktiviert ist, wird die Verbindung an den Verbindungspool zurückgegeben. Bei der erneuten Verwendung der an den Pool zurückgegebenen Verbindung wird dann ein Fehler ausgelöst.</span><span class="sxs-lookup"><span data-stu-id="bc831-207">However, if pooling is enabled, the connection is returned to the pool, and an error occurs when the pooled connection is reused.</span></span> <span data-ttu-id="bc831-208">Weitere Informationen finden Sie im Knowledge Base-Artikel "[SQL-Anwendungs Rollen Fehler mit OLE DB Ressourcen Pooling](https://support.microsoft.com/default.aspx?scid=KB;EN-US;Q229564)".</span><span class="sxs-lookup"><span data-stu-id="bc831-208">For more information, see the Knowledge Base article, "[SQL application role errors with OLE DB resource pooling](https://support.microsoft.com/default.aspx?scid=KB;EN-US;Q229564)."</span></span>  
  
### <a name="application-role-alternatives"></a><span data-ttu-id="bc831-209">Alternativen zu Anwendungsrollen</span><span class="sxs-lookup"><span data-stu-id="bc831-209">Application Role Alternatives</span></span>  

 <span data-ttu-id="bc831-210">Es wird empfohlen, die Sicherheitsmechanismen zu nutzen, die anstelle der Anwendungsrollen verwendet werden können.</span><span class="sxs-lookup"><span data-stu-id="bc831-210">We recommend that you take advantage of security mechanisms that you can use instead of application roles.</span></span> <span data-ttu-id="bc831-211">Weitere Informationen finden Sie unter [Erstellen von Anwendungs Rollen in SQL Server](./sql/creating-application-roles-in-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="bc831-211">For more information, see [Creating Application Roles in SQL Server](./sql/creating-application-roles-in-sql-server.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="bc831-212">Weitere Informationen</span><span class="sxs-lookup"><span data-stu-id="bc831-212">See also</span></span>

- [<span data-ttu-id="bc831-213">Verbindungspooling</span><span class="sxs-lookup"><span data-stu-id="bc831-213">Connection Pooling</span></span>](connection-pooling.md)
- [<span data-ttu-id="bc831-214">SQL Server und ADO.NET</span><span class="sxs-lookup"><span data-stu-id="bc831-214">SQL Server and ADO.NET</span></span>](./sql/index.md)
- [<span data-ttu-id="bc831-215">Leistungsindikatoren</span><span class="sxs-lookup"><span data-stu-id="bc831-215">Performance Counters</span></span>](performance-counters.md)
- [<span data-ttu-id="bc831-216">Übersicht über ADO.NET</span><span class="sxs-lookup"><span data-stu-id="bc831-216">ADO.NET Overview</span></span>](ado-net-overview.md)
